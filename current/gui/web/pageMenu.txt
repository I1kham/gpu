<html>

<head>
	<title>GUI</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link href="style.css" rel="stylesheet" type="text/css">
	<style>
		.msg-cpu-beverage-booking {
			position: absolute; bottom: 40px; font-size: 15px; margin: 0 auto; left: 0; right: 0;
		}
		.footer_center {
			padding-top: 0;
		}
		
		.rheaModal {
			position: absolute; top: 0;bottom: 0;left: 0;right: 0;background-color: rgba(0,0,0,.85); z-index: 10;
		}
		.rheaModal .rheaModalContent{
			margin: 100px;border: 3px solid white;border-radius: 4px;position: absolute;top: 0;bottom: 0;left: 0;right: 0;background-color: #000;
		}
		.rheaModal .rheaModalContent .milkBgImage{
			border: 1px solid white;width: 270px; height: 330px; margin: 30px; background-image: url("img/milk_tank.png");background-size: contain;float: left;
		}

		.rheaModal .milkTextualContent {
			margin-top: 30px; float: left; width: 470px; height: 330px; position: relative;
		}

		.rheaModal .btnAction {
			display: table; width: 100%; height: 37px; border: 1px solid; border-radius: 25px; color: #838383; font-weight: bold; position: relative; cursor: pointer; margin-top: 25px;
		}

		.rheaModal .btnAction p {
			display: table-cell; vertical-align: middle; padding: 0 20px;
		}

		.milkBottle {
			position: absolute;top: 0;bottom: 0; left: 0; right: 0; background-image: url("img/milk_bottle.png");background-size: contain;background-repeat: no-repeat;background-position: center;width: 25px;height: 50px;margin: auto; z-index: 1;
		}
	</style>
</head>

<body onLoad="rheaBootstrap()">
<div id="mainWrapper" class="wrapper1024x600">
	<div id="lngPanel" onclick="lngPanelOff()">
		<div id="lngSelections" style="background-color:black;">Overlay Text</div>
	</div>
	
	<div class="header">
		<center><img id="headerImage" src="img/logo_rhea.jpg" style="width: 126px; height: 40px; display: none"></center> 	
	</div>

	<div class="page">
		<div id="divPageMenuLeft" class="pageMenuLeft" onclick="onLeftArrowClicked()">
			<br><br><br><br><br><br><br><img draggable='false' id="btnLeftArrow" class="pageMenuArrow disabled" src="img/leftArrow.png">
		</div>

		<div class="pageMenuCenter" style="overflow:hidden;">
			<div id="divIconMenuWindow" style="width:100%; height:100%; position:relative; left:0;">
				<div id="divIconMenuContainer" style="position:absolute; left:0; top:0"></div>
			</div>
			<div class="clear"></div>
		</div>

		<div id="divPageMenuRight" class="pageMenuRight" onclick="onRightArrowClicked()">
			<br><br><br><br><br><br><br><img draggable='false' id="btnRightArrow" class="pageMenuArrow disabled" src="img/rightArrow.png">
		</div>
		<div class="clear"></div>
	</div>

	<div class="footer">
		<div class="footer_left">
			<div id="btnRefillMilk" class="btnLang" onclick="milkPopup_open()" style="display: none;width: 275px; background-image: none; border: 1px solid; border-radius: 25px;">
				<img draggable="false" src="img/milk_bottle.png">
				<p id="refillMilkLabel">REFILL MILK</p>
			</div>
		</div>
		<div class="footer_center">
			<div id="divCPUMessage" style="display:none;"></div>	
			<div id="beverageBookingLoader" class="booking-container" style="display: none;">
				<div class="progress-bar">
					<div class="progress-icon" style="background-image: url(img/beverage_booking.png); background-repeat: no-repeat; background-position: center; width: 15px; height: 47px;"></div>
					<div id="currentDrink" class="progress-title">Current drink</div>
					<div class="progress-bar-value">
						<span id="progress-cursor"></span>
					</div>
				</div>
			</div>
		</div>
		<div class="footer_right">
			<div id="langButtonImg_def" class="btnLang" onclick="divLangMenu_open()" style="display: none;">
				<img draggable="false" src="img/flagsButton.png">
				<p>LANGUAGE</p>
			</div>
			<img id="langButtonImg" draggable="false" src="" onclick="divLangMenu_open()" style="display: none; cursor:pointer; position: absolute; bottom: 10px; right: 15px;">
		</div>
		<div class="clear"></div>
	</div>
	
	
	<!-- hotspot nell'angolo in alto a sx. Cliccando 4/5 volte su questo hotspot compare al "menu di acesso veloce"-->
	<div id="divASx" style="position:absolute; top:0; left:0; width:110px; height:150px; background-color:transparent" onclick="onLogoClicked()">&nbsp;</div>
	
	
	<!-- menu di accesso veloce -->
	<div id="divFastMenu" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.9); overflow:hidden; z-index: 11;">
		<div style="width:94%; margin:20px auto auto auto; position:relative">
			<div id="btnsContainer" style="margin:160px 60px 0 90px">
				<div id="btnBO_cleaning" class="btnQuadratoGrosso" style="position:absolute; top:0; left:205px;" onclick="onBtnCleaning()"></div>
				<div id="btnBO_milkerCleaning" class="btnQuadratoGrosso" style="position:absolute; top:0; left:555px;" onclick="onBtnMilkerCleaning()"></div>
				<div id="btnBO_FileInfo" class="btnQuadratoGrosso" style="position:absolute; top:120px; left:205px;" onclick="onBtnFileInfo()"></div>
				<div id="btnBO_dataAudit" class="btnQuadratoGrosso" style="position:absolute; top:120px; left:555px;" onclick="onBtnDataAudit()"></div>
				<div id="btnBO_AllInOne" class="btnQuadratoGrosso" style="position:absolute; top:240px; left:205px; display: none;" onclick="onBtnAllInOne()"></div>
			</div>
			<div id="btnBO_hideFastMenu" class="btnQuadratoGrosso" style="position:absolute; top:300px; left:700px; color:#f00;" onclick="hideFastMenu()"></div>
			
			<div style="position: absolute; top: 415px; font-size: 12px; color: #777">rv-001: <span><b id="rmVersion">v2.7.18</b></span></div>
		</div>
	</div>
	
	<!-- menu sw version -->
	<div id="FileInfo_div" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.9); overflow:hidden;z-index:999">
		<div style="width:94%; margin:20px auto auto auto; position:relative">
			<p>CPU: <b id="FileInfo_CpuModel">...</b></p>
			<p>&nbsp;&nbsp;&nbsp;<b id="FileInfo_CpuFilename">...</b></p><br>
			<p>GPU: <b id="FileInfo_GpuVersion">...</b></p><br>
			<p>GUI: <b id="FileInfo_GuiFilename">...</b></p><br>
			<p>VMC SETTINGS: <b id="FileInfo_Da3Filename">...</b></p>
			<div class="btnQuadratoGrosso" style="position:absolute; top:400px; left:700px; color:#f00" onclick="onFileInfoClose()"><p>CLOSE</p></div>
		</div>
	</div>	

	<!-- menu lingue -->
	<div id="divLangMenu" style="z-index: 999;display:none; position:absolute; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.9); overflow:hidden;">
		<div class="btnIndietro" onclick="divLangMenu_close()"><img draggable='false' src="img/btnHome.png"></div> 
		<div class="pageConfirm_bigFont" style="text-align:center; color:#aaa; margin:25px 0 60px 0;">SELECT YOUR LANGUAGE</div>

		<div id="divLangMenu_content"></div>
	</div>
	
	<div id="rheaModal" class="rheaModal" style="display: none">
		<div id="rheaModalContent" class="rheaModalContent"></div>
	</div>

	<div id="divPleaseWait" style="display:none; position:absolute; top:30px; left:0; width:100%; height:570px; z-index:200; background-color:rgba(0,0,0,0.9)">
		<br><br><br><br><br><br><br>
		<center><img src="img/animationRound.gif"></center>
	</div>
</div>




<!-- le opzioni di layout per questa pagina sono qui -->
<script src="config/allowedLang.js"></script>
<script src="config/lang.js"></script>
<script src="config/mainMenuIcons.js"></script>
<script src="config/pageMenu.js"></script>
<script src="config/MMI.js"></script>
<script src="config/pageStandby.js"></script>
<script src="js/rheaBootstrap.js"></script>
<script src="js/PanelPinCode.js"></script>
<script src="js/popup.js"></script>
<script language="javascript">

var timerGotoPageStandby = null;
var isMilkerAlive = 0;
var bShowOnlyImportantCPUMessages = 0;
var selRunning_iconNum = 0;
var selRunning_selThatWasStarted = 0;
var isRheamediaPreviewBox = 0;

var isRFIDJugDetected = 0;
var isCupDetected = false;

var JUG_STATUS = {
	ALWAYS_VISIBLE: 1,
	NEVER_VISIBLE: 2,
	ON_RFID_STATUS: 3
};

function onRheaBootstrapFinished() 
{
	pinCodePanel = new PanelPinCode("mainWrapper");
	lang_loadLang(lang_getCurLangISOCode()).then (onAfterLangLoaded);
}

function onAfterLangLoaded()
{
	if( typeof beverageBookingLabel !== 'undefined' ) {
		rheaSetElemHTML(rheaGetElemByID('currentDrink'), beverageBookingLabel);
	}

	if(Rhea_session_getOrDefault('beverageBooking', false)) {	
		var cpuMSG = rheaGetElemByID('divCPUMessage');
		cpuMSG.classList.add('msg-cpu-beverage-booking');

		rheaShowElem(rheaGetElemByID('beverageBookingLoader'));
		beverageBookingAnimation();
	}
	
	if ("jug" in rhea.selection_getBySelNumber(1))
		onAfterJugInfoLoaded();
	else
	{
		for (var i=1; i<=rhea.selection_getCount(); i++)
			rhea.selection_getBySelNumber(i).jug = 0;
		
		rhea.ajax ("jugRepetitions", "").then( function(result)
		{
			var j = JSON.parse(result);
			for (var i=0; i<j.n; i++)
			{
				if (j.s[i]=='a' || j.s[i]=='A')
					rhea.selection_getBySelNumber(i+1).jug = 10;
				else
					rhea.selection_getBySelNumber(i+1).jug = parseInt(j.s[i]);
			}				
			onAfterJugInfoLoaded();
		})
		.catch( function(result)
		{
			onAfterJugInfoLoaded();
		});	
	}

	checkHeaderImage();
}

function checkHeaderImage()
{
	if (typeof headerImageImg !== "undefined" && headerImageImg)
	{
		var img = rheaGetElemByID("headerImage");
		img.src = 'upload/' + headerImageImg;
	}

	if (typeof hideHeaderImage === "undefined" || !hideHeaderImage)
	{
		rheaShowElem(rheaGetElemByID("headerImage"));
	}
}

function onAfterJugInfoLoaded() 
{
	//carico le nutritional info per sapere se alle selezioni è associata una nutritional-info. Mi serve
	//nel caso in cui sia abilitata l'opzione "one click selection"
	lang_loadJS ("nutriInfo").then ( function()	{});


	rhea.onEvent_selectionAvailabilityUpdated = function () 
	{
		onSelectionAvailabilitUpdated();
	}
	
	rhea.onEvent_cpuStatus = function (statusID, statusStr, flag16)
	{
		console.log ("onEvent_cpuStatus[" +statusID +"][" +statusStr +"][" +flag16 +"]");
		//stato del cappuccinatore
		if (isMilkerAlive)
		{
			if ((flag16 & 0x04) == 0)
				isMilkerAlive = 0;
		}
		else
		{
			if ((flag16 & 0x04) != 0)
				isMilkerAlive = 1;
		}

		if (isRFIDJugDetected)
		{
			if ((flag16 & 0x0040) == 0){
				isRFIDJugDetected = 0;
				toggleJugIcons( false );
			}	
		}
		else
		{
			if ((flag16 & 0x0040) != 0) {
				isRFIDJugDetected = 1;
				toggleJugIcons( true );
			}	
		}

		if ((flag16 & 0x0100) != 0) {		// Check cup presence
			isCupDetected = true;
			resetTimerGotoPageStandby();
		} 
		else
		{
			isCupDetected = false;
			resetTimerGotoPageStandby();
		}

		if ((flag16 & 0x1000) != 0) 		// ALL IN ONE
		{
			showBtnAllInOne();
		}
		else
		{
			// DO NOTHING
		}

		if ( parseInt(statusID) === 8 ) {	// Start of washing process
			if (typeof rinsingHidden === 'undefined' || !rinsingHidden)
				gotoRinsingPage();
		}
	}
	
	rhea.onEvent_cpuMessage = function(msg, importanceLevel)
	{
		//console.log ("onEvent_cpuMessage[" +msg +"][" +importanceLevel +"]");
		if (!bShowOnlyImportantCPUMessages)
			importanceLevel = 100;
		var dCPU = rheaGetElemByID ("divCPUMessage");
		if (importanceLevel == 0)
			rheaHideElem(dCPU)
		else
		{			
			rheaSetElemHTML(dCPU, msg);
			rheaShowElem(dCPU);
		}
	}
	
	rhea.onEvent_selectionReqStatus = function (status)
	{
		if (status == 3 || status == 4) {
			if(Rhea_session_getOrDefault('beverageBooking', false)){
				Rhea_session_clearObject('beverageBooking');
				location.reload();
			}
		}

		switch (status)
		{
			case 1: // wait for credit
				console.log ("sel waiting..");
				break;
				
			case 2:// selection started
				gotoPagePreparingSel(0);
				break;
				
			case 5:// selection started, can use btnStop
				gotoPagePreparingSel(1);
				break;

			case 30:	// finished_KO_needSmallCupDown
				errorCupPopup_open('down');
				break;

			case 31:	// finished_KO_needSmallCupUp
				errorCupPopup_open('up');
				break;

			case 32:	// finished_KO_needSmallCupUpOrDown
				errorCupPopup_open('downup');
				break;

			case 33:	// finished_KO_needBigCup
				errorCupPopup_open('big');
				break;

			case 34:	// finished_KO_needACup
				errorCupPopup_open('any');
				break;

			default:				
			case 3: // selection aborted
				console.log ("sel aborted [" +status +"]");
				rheaHideElem (rheaGetElemByID("divPleaseWait"));
				selRunning_iconNum = 0;
				selRunning_selThatWasStarted = 0;
				break;
		}
	
	}	
	
	//rhea.onEvent_selectionPricesUpdated = function () {}
	//rhea.onEvent_creditUpdated = function () {}


	//il numero di righe/colonne della grid può essere passato anche via urlGet
	var nGridRow = rheaGetURLParamOrDefault("gridR", mainMenuPageOptions.icon_numRow);
	var nGridCol = rheaGetURLParamOrDefault("gridC", mainMenuPageOptions.icon_numIconPerRow);
	setupIconContainer(nGridRow, nGridCol);
	rhea.requestGPUEvent(RHEA_EVENT_CPU_MESSAGE);
	rhea.requestGPUEvent(RHEA_EVENT_CPU_STATUS);
	
	if (Rhea_session_getOrDefault("rheamedia2preview","0")=="1")
		isRheamediaPreviewBox=1;
	//console.log ("isRheamediaPreviewBox=" +isRheamediaPreviewBox);
}

function setupQuickMenu()
{
	if( typeof qmRinsingPage !== 'undefined' && qmRinsingPage ) {
		rheaSetElemHTML(rheaGetElemByID("btnBO_cleaning"), '<p>' + qmRinsingPage + '</p>');
	}
	
	if( typeof qmMilkerCleaning !== 'undefined' && qmMilkerCleaning ) {
		rheaSetElemHTML(rheaGetElemByID("btnBO_milkerCleaning"), '<p>' + qmMilkerCleaning + '</p>');
	}

	if( typeof qmSoftwareVersion !== 'undefined' && qmSoftwareVersion ) {
		rheaSetElemHTML(rheaGetElemByID("btnBO_FileInfo"), '<p>' + qmSoftwareVersion + '</p>');
	}

	if( typeof qmDataAudit !== 'undefined' && qmDataAudit ) {
		rheaSetElemHTML(rheaGetElemByID("btnBO_dataAudit"), '<p>' + qmDataAudit + '</p>');
	}

	if( typeof qmCleaningAllInOne !== 'undefined' && qmCleaningAllInOne ) {
		rheaSetElemHTML(rheaGetElemByID("btnBO_AllInOne"), '<p>' + qmCleaningAllInOne + '</p>');
	}

	if( typeof qmCloseButton !== 'undefined' && qmCloseButton ) {
		rheaSetElemHTML(rheaGetElemByID("btnBO_hideFastMenu"), '<p>' + qmCloseButton + '</p>');
	}
}

function toggleJugIcons( show ) {
	if (jugConfiguration === JUG_STATUS.ON_RFID_STATUS) {
		var jugIcons = document.querySelectorAll( '.pageMenu_jugIcon' );

		for (var i=0; i<jugIcons.length; i++ ) {
			show? rheaShowElem( jugIcons[i] ) : rheaHideElem(jugIcons[i]);
		}
	}
}

function onAfterIconAreDisplayed()
{
	setupNavigator();
	initScrollMenu();
	prepareFooterItems();
	resetTimerGotoPageStandby();
	rhea.requestGPUEvent(RHEA_EVENT_SELECTION_AVAILABILITY_UPDATED);
		
	divLangMenu_setup(lang_getCurLangISOCode());
}

function prepareFooterItems() {

	var langDefBtn = document.querySelector( '#langButtonImg_def' );

	if( typeof objFooter === 'undefined' || !objFooter || !Object.keys( objFooter ).length ) {
		if (allLang.split(",").length > 1) { rheaShowElem(langDefBtn); }

		return; 
	}
	

	var langBtn = document.querySelector( '#langButtonImg' );
	


	if( objFooter.langButtonImg && objFooter.langButtonImg !== 'NULL')  { 
		langBtn.src = 'upload/' + objFooter.langButtonImg; 
		if (allLang.split(",").length > 1) { rheaShowElem(langBtn); }
	} else {
		if (allLang.split(",").length > 1) { rheaShowElem(langDefBtn); }
	}
}

function onSelectionAvailabilitUpdated()
{
	var nIcon = MMI_getCount();
	var showBtnRefillMilk = false;
	rheaHideElem(rheaGetElemByID("btnRefillMilk"));

	for (var i=0; i<nIcon; i++)
	{
		var d = rheaGetElemByID("divIcon" +i);
		rheaRemoveClassToElem(d, "disabled");
		
		var milkBottle = rheaGetElemByID("milkBottle" +i);
		if (milkBottle)
		{
			rheaHideElem(milkBottle);
		}

		if (MMI_isEnabled(i) == 0){
			if(!Rhea_session_getOrDefault('beverageBooking', false)) {
				rheaAddClassToElem(d, "disabled");
			}
		
			if (typeof freshMilkHidden !== 'undefined' && !freshMilkHidden) {
				if (MMI_atLeastOneWithFreshMilk(i) == 1 && rhea.isOutOfFreshMilk == 1){
					// if(Rhea_session_getOrDefault('beverageBooking', false)) {
						rheaAddClassToElem(d, "disabled");
						showBtnRefillMilk = true;

						rheaShowElem(rheaGetElemByID("milkBottle" +i));
					// }
				}
			}
		}
		
		if (showBtnRefillMilk) {
			rheaShowElem(rheaGetElemByID("btnRefillMilk"));

			if (typeof refillFreshMilkBtn != 'undefined' && refillFreshMilkBtn) {
				var d = rheaGetElemByID("refillMilkLabel");
				rheaSetElemHTML(d, refillFreshMilkBtn);
			}
		}
	}
}						

function getTimeMSec() { return Date.now(); }


//------- Selection scroll
var scrollInfo = null;
var animInterval = null;
function ScrollInfo()
{
	this.mouseStartClickPosX = 0;
	this.btnPressed = false;
	this.startTimeMSec = 0;
	this.lastTimeMovedMSec = 0;
	this.lastTimePosX = 0;
	this.iconClicked = -1;
	this.divLeftAtStart = 0;
}

function initScrollMenu() 
{
	scrollInfo = new ScrollInfo();
	
	//--------- Page Scroll Funzioni -------------------------------------
	divIconMenuWindow.addEventListener('mouseleave', function (ev)
	{
		if (!scrollInfo.btnPressed)
			return;
		if (ev.relatedTarget.id == "divPageMenuLeft" || ev.relatedTarget.id == "divPageMenuRight")
		{
			doEvent_mouseUp(ev);
		}
	}, true);
	
	divIconMenuWindow.addEventListener('mousedown', function (ev)
	{
		resetTimerGotoPageStandby();
		scrollInfo.iconClicked = ev.srcElement.getAttribute("iconNum");
		scrollInfo.btnPressed = true;
		scrollInfo.startTimeMSec = ev.timeStamp;
		scrollInfo.lastTimeMovedMSec = scrollInfo.startTimeMSec;
		scrollInfo.divLeftAtStart = parseInt(divIconMenuWindow.style.left);
		scrollInfo.mouseStartClickPosX = ev.clientX;
	}, true);

	divIconMenuWindow.addEventListener('mouseup', function (ev)
	{
		doEvent_mouseUp(ev);
	}, true);

	divIconMenuWindow.addEventListener('mousemove', function (ev) 
	{
		ev.preventDefault();
		if (!scrollInfo.btnPressed)
			return;
			
		//se il time trascorso dall'ultimo mouse move è alto, lo considero come un nuovo "primo mouse down"
		var timeElaspedSinceLastMoveMSec = ev.timeStamp - scrollInfo.lastTimeMovedMSec;
		if (timeElaspedSinceLastMoveMSec > 300)
		{
			scrollInfo.mouseStartClickPosX = ev.clientX;
			scrollInfo.divLeftAtStart = parseInt(divIconMenuWindow.style.left);
		}	
	
		scrollInfo.lastTimeMovedMSec = ev.timeStamp;
		var offsetX = ev.clientX - scrollInfo.mouseStartClickPosX;
			
		var new_x = scrollInfo.divLeftAtStart + offsetX;
		if (new_x > 0)
			new_x = 0;
		divIconMenuWindow.style.left = new_x + 'px';
		
		//in che pagina siamo?
		var curPage = (-new_x / mainMenuIconPageW);
		updateNavigatorIcon(curPage);

	}, true);
}

function doEvent_mouseUp (ev)
{
	if (!scrollInfo.btnPressed)
		return;

	resetTimerGotoPageStandby();
	scrollInfo.btnPressed = false;
	
	var THRESHOLD = 20;
	var delta = (ev.clientX - scrollInfo.mouseStartClickPosX);
	if (delta < -THRESHOLD || delta > THRESHOLD)
	{
		//ho rilasciato il pulsante ma sono a più di THRESHOLD pixel dal punto in cui ho originalmente cliccato,
		//quindi non lo posso considerare un mouseclick, lo considero come una strisciata.
		//Se ho tolto il dito in fretta, scrollo, se invece ho lasciato il dito appoggiato per un po', rimango fermo dove sono
		var elapsedClickTimeSinceLastMoveMSec = ev.timeStamp - scrollInfo.lastTimeMovedMSec;
		if (elapsedClickTimeSinceLastMoveMSec < 100)
		{
			var THRESHOLD_TO_SCROLL_A_PAGE = 100;
			if (delta > THRESHOLD_TO_SCROLL_A_PAGE || delta <-THRESHOLD_TO_SCROLL_A_PAGE)
			{
				var toScroll = mainMenuIconPageW;
				if (delta < -THRESHOLD)
					toScroll = -toScroll;

				var d = rheaGetElemByID("divIconMenuWindow");
				var cur_x = rheaGetElemLeft(d);
				var new_x = cur_x + toScroll;
				
				//console.log ("SCROOOOL, cur_x=" +cur_x +", new_x="+new_x);
				//console.log ("mainMenuIconPageW="+mainMenuIconPageW);
				
				if (new_x > 0)
					new_x = 0;
					
				var min_x = -mainMenuIconPageW * (mainMenuIconNumPage-1)
				if (new_x < min_x)	
					new_x = min_x;
					
				clearInterval(animInterval);
				animInterval = rheaSmoothScrollElemLeft(d, new_x, 500);
				
				var page = -new_x / mainMenuIconPageW;
				updateNavigatorIcon(page);
				return;
			}
		}
	}
	else 
	{
		//ho rilasciato il dito nei pressi di dove ho cliccato all'inizio
		//Se non è passato troppo tempo, lo passo per click
		var elapsedClickTimeMSec = ev.timeStamp - scrollInfo.startTimeMSec;
		if (elapsedClickTimeMSec < 750)
		{
			//console.log ("delta=" +delta +",elapsedClickTimeMSec="+elapsedClickTimeMSec);
			//alert ("Click");
			onIconMenuClicked(scrollInfo.iconClicked);
			return;
		}
	}
	
	alignToClosestMenuIcon();
}

function alignToClosestMenuIcon()
{
	var d = rheaGetElemByID("divIconMenuWindow");
	var curx = rheaGetElemLeft(d);
	var curCol = parseInt(curx / mainMenuIconW);

	clearInterval(animInterval);
	animInterval = rheaSmoothScrollElemLeft(d, curCol*mainMenuIconW, 200);
}

function setupNavigator()
{
	if (mainMenuIconNumPage < 2)
	{
		rheaHideElem (rheaGetElemByID("btnLeftArrow"));
		rheaHideElem (rheaGetElemByID("btnRightArrow"));
		return;
	}
	var html = "";
	var i;
	var d = rheaGetElemByID("divIconMenuWindow");
	var x = rheaGetElemLeft(d);
	var curPage = parseInt(-x / mainMenuIconPageW);

	for (i = 0; i < mainMenuIconNumPage; i++) 
	{
		var id = "nav_page_" +i;
		var css = "pageMenu_navigatorIcon";
		if(i == curPage)
			css += " selected";
		html += "<div id='" +id +"' class='" +css +"' onclick='goToPageMenu(" + i + ");' >";
		html += "</div>";
	}
	html += "<div class='clear'></div>";
	//rheaSetDivHTMLByName("pageIndex", html);
	updateNavigatorIcon(0);
}

function updateNavigatorIcon(pageIN)
{
	if (mainMenuIconNumPage < 2)
		return;


	if (pageIN < 0)
		pageIN = 0;
	else if (pageIN >= mainMenuIconNumPage) 
		pageIN = mainMenuIconNumPage - 1;

	//accende/spegne le frecce	sx/dx
	var d = rheaGetElemByID("btnLeftArrow");
	rheaRemoveClassToElem (d, "disabled");
	if (pageIN == 0)
		rheaAddClassToElem (d, "disabled");
	
	d = rheaGetElemByID("btnRightArrow");
	rheaRemoveClassToElem (d, "disabled");
	if (pageIN >= mainMenuIconNumPage-1)
		rheaAddClassToElem (d, "disabled");		
		
}
	
function goToPageMenu(pageIN) 
{
	resetTimerGotoPageStandby();
	var page = parseInt(pageIN);
	if (page < 0)
		page = 0;
	else if (page >= mainMenuIconNumPage) 
		page = mainMenuIconNumPage - 1;
		
	var d = rheaGetElemByID("divIconMenuWindow");
	x = page * mainMenuIconPageW;
	clearInterval(animInterval);
	animInterval = rheaSmoothScrollElemLeft(d, -x, 500);
	updateNavigatorIcon(page);
}
//-----------------------------------------------------------------------------


function resetTimerGotoPageStandby() 
{
	if (mainMenuPageOptions.gotoPageStandbyAfterMSec <= 1000)
		return;

	if (null != timerGotoPageStandby)
		clearInterval(timerGotoPageStandby);

	timerGotoPageStandby = setInterval(gotoPageStandby, mainMenuPageOptions.gotoPageStandbyAfterMSec);
}

function gotoPageStandby()  
{
	if (standbyPageOptions.enabled==0)
	{
		//allo scattare del timeout, anche se non vado in pagina standy, ricarico la
		//lingua di default
		if (defaultLang != lang_getCurLangISOCode())
			setLanguage(defaultLang);
		return;
	}

	if (!isCupDetected) 
	{
		window.location = "pageStandby.html";
	} 
}

function gotoRinsingPage() { window.location = "pageRinsing.html";  }

var mainMenuIconW = 0;
var mainMenuIconH = 0;
var mainMenuIconPageW = 0;
var mainMenuIconNumPage = 0;
function setupIconContainer(nRow, nIconPerRow)
{
	var d = rheaGetElemByID("divIconMenuWindow");
	mainMenuIconPageW = rheaGetElemWidth(d);
	var pageH = rheaGetElemHeight(d);


	mainMenuIconW = parseInt(mainMenuIconPageW / nIconPerRow);
	mainMenuIconH = parseInt(pageH / nRow);

	var nIcon = MMI_getCount();
	var nIconPerPage = nIconPerRow * nRow;
	var styleForIconPage = "class='pageMenu_iconPage' style='width:" + mainMenuIconPageW + "px'";
	
	//prepara le pagine di icone
	mainMenuIconNumPage = 0;
	var n = 0;
	var html = "";
	while (n < nIcon)
	{
		var pageID = "mainMenuIconPage" + mainMenuIconNumPage;
		html += "<div id='" + pageID + "' " + styleForIconPage + "></div>";
		
		mainMenuIconNumPage++;
		n+= nIconPerPage;
	}
	html += "<div class='clear'></div>";
	d = rheaGetElemByID("divIconMenuContainer");	
	rheaSetElemWidth(d, mainMenuIconNumPage * mainMenuIconPageW);
	rheaSetElemHTML(d, html);
	Rhea_session_setValue ("jug", "0");

	setupIconPage (0, nIconPerPage);
}


var jug_iconNum = -1;
var jug_isIconSelected = 0;
function setupIconPage (iPage, nIconPerPage)
{
	//console.log ("setupIconPage (" +iPage +", " +nIconPerPage +")");

	var styleForIconDiv = "class='pageMenu_iconWrapper' style='position: relative; width:" + mainMenuIconW + "px; height:" + mainMenuIconH + "px;'";
	var nIcon = MMI_getCount();
	
	var startIcon = iPage * nIconPerPage;
	var n = nIconPerPage;
	if (startIcon + n > nIcon)
		n = nIcon - startIcon; 
	
	var html = "";
	var ndTextConfigured = false;

	while (n--)
	{
		var iconDisplayName = MMI_getDisplayName(startIcon);
		var image = "<img iconNum='" + startIcon + "' draggable='false' src='" + MMI_getImgForPageMenu(startIcon) + "'>";

		var cssForIconDisabled="";
		if (MMI_isEnabled(startIcon) == 0)
			cssForIconDisabled=" disabled";

		if (iconDisplayName=="JUG")
			jug_iconNum = startIcon;

		var ndIconText = rhea_mainMenuIconSecondName[startIcon] && rhea_mainMenuIconSecondName[startIcon] !== 'NULL'? "<div id='icon_nd_text" +startIcon +"' class='pageMenu_icon_nd_text' iconNum='" + startIcon + "'>" + rhea_mainMenuIconSecondName[startIcon] + "</div>" : '';
		
		if( ndIconText ) {
			ndTextConfigured = true;
		}

		var isHidden  = JSON.parse(rheaMainMenuIcons[startIcon].hidden);
		var visibility = isHidden? "style='display: none'" : ""; 
		
		html += "<div " + styleForIconDiv + ">"
			  + (typeof freshMilkHidden !== 'undefined' && !freshMilkHidden? '<div id="milkBottle' + startIcon + '" class="milkBottle" style="display: none"></div>' : "" )
			  + " <div id='divIcon" + startIcon + "'  iconNum='" + startIcon + "' class='pageMenu_icon" + cssForIconDisabled + "'" + visibility  + " >"
			  + "  <div class='pageMenu_icon_img' iconNum='" + startIcon + "'>" + image + "</div>"
			  + "  <div id='icon_text" +startIcon +"' class='pageMenu_icon_text' iconNum='" + startIcon + "'>" + iconDisplayName + "</div>"
			  + ndIconText;
			  
		if ( typeof MMI_isJuggable !== 'undefined' && MMI_isJuggable(startIcon) && jugConfiguration !== JUG_STATUS.NEVER_VISIBLE ) {
			var style = '';

			if( jugConfiguration === JUG_STATUS.ON_RFID_STATUS ) {
				style = isRFIDJugDetected? " style='display: block;'" : " style='display: none;'";
			}

			html += "<div class='pageMenu_jugIcon'" + style + "><img src='img/jugIcon.png'></div>";
		}
			  
		html += " </div>"
			  + "</div>";
		startIcon++;
	}

	var pageID = "mainMenuIconPage" + iPage;
	d = rheaGetElemByID(pageID);
	rheaSetElemHTML(d, html);
	
	
	iPage++;
	if (iPage < mainMenuIconNumPage)
		setTimeout(function() { setupIconPage (iPage, nIconPerPage);}, 100);
	else
		onAfterIconAreDisplayed();
	
	if( ndTextConfigured ) {
		var pageMenuElems = document.querySelectorAll( '.pageMenu_icon_text' );
	
		for (var i=0; i<pageMenuElems.length; i++) {
			pageMenuElems[i].style = 'font-size:0.85em!important';
		}
	}
}


function onLeftArrowClicked() 
{
	resetTimerGotoPageStandby();

	var d = rheaGetElemByID("divIconMenuWindow");
	var x = rheaGetElemLeft(d);

	var curPage = -x / mainMenuIconPageW;
	curPage--;
	goToPageMenu(curPage);
}

function onRightArrowClicked() 
{
	resetTimerGotoPageStandby();

	var d = rheaGetElemByID("divIconMenuWindow");
	var x = rheaGetElemLeft(d);

	var curPage = -x / mainMenuIconPageW;
	curPage++;
	goToPageMenu(curPage);
}

/****************************************
 * chiamata quando una icona bevanda viene cliccata
 */
function onIconMenuClicked (iconNum)
{
	resetTimerGotoPageStandby();
	
	if (iconNum == jug_iconNum)
	{	
		//ho cliccato l'icona JUG
		var d = rheaGetElemByID("icon_text" + iconNum);
		if (jug_isIconSelected)
		{
			jug_isIconSelected=0;
			rheaRemoveClassToElem (d, "pageMenu_icon_text_hl");
			Rhea_session_setValue ("jug", "0");
		}
		else
		{
			jug_isIconSelected=1;
			rheaAddClassToElem (d, "pageMenu_icon_text_hl");
			Rhea_session_setValue ("jug", rheaMainMenuIcons[iconNum].selNum);
		}
		return;
	}

	if( !iconNum ) { return; }
	
	if (MMI_isEnabled(iconNum) || Rhea_session_getOrDefault('beverageBooking', false))
	{
		selRunning_iconNum = iconNum;
		selRunning_selThatWasStarted = MMI_getLinkedSelectionNumber(iconNum);
		if (mainMenuPageOptions.oneClickSelection == 1 && !Rhea_session_getOrDefault('beverageBooking', false))
		{
			//Se l'opzione "one click selection" è attiva, allora può essere che si debba far partire la selezione
			//direttamente da qui, senza passare per pageConfirm. E' necessario che la selezione non abbia "nutritional info" e che il 
			//suo prezzo sia 0 (oppure siamo in freevend)
			if (rheaLang_nutriInfo[iconNum] =="")
			{
				var selInfo = rhea.selection_getBySelNumber(selRunning_selThatWasStarted);
				if (parseFloat(selInfo.price) <= 0 || rhea.isFreevend || isRheamediaPreviewBox)
				{
					console.log ("Starting sel num:" +selRunning_selThatWasStarted);
					bShowOnlyImportantCPUMessages=0;
					rheaShowElem (rheaGetElemByID("divPleaseWait"));
					rhea.selection_start(selRunning_selThatWasStarted);
					return;
				}
			}
		}
		
		window.location = "pageConfirm.html?iconMenu=" + iconNum;
		
	}
}

function setLanguage(twoCharISOCode) 
{
	resetTimerGotoPageStandby();

	lang_loadLang(twoCharISOCode)
		.then(function (result) {
			window.location = window.location;
		})
		.catch(function (result) {
			rheaLog("AJAX::error => " + result);
		});
}

function onBtnInfoClicked() 	{ resetTimerGotoPageStandby(); }
function changeGrid(nRow, nCol) { window.location = "pageMenu.html?gridR=" +nRow + "&gridC=" +nCol; }
function gotoPageInfo()			{ window.location = "pageInfo.html"; }


//******************************************
var debug_logo_nClick = 0;
var debug_logo_lastTimeClicked = 0;	
function onLogoClicked()
{
	if (debug_logo_lastTimeClicked == 0)
	{
		debug_logo_lastTimeClicked = getTimeMSec();
		debug_logo_nClick = 1;
	}
	else
	{
		var timeNowMSec = getTimeMSec();
		var diffMSec =  timeNowMSec - debug_logo_lastTimeClicked;
		if (diffMSec > 1500)
			debug_logo_lastTimeClicked = debug_logo_nClick = 0;
		else
		{
			debug_logo_lastTimeClicked = timeNowMSec;
			debug_logo_nClick++;
			if (debug_logo_nClick >= 3)
			{
				debug_logo_lastTimeClicked = debug_logo_nClick = 0;
				showFastMenu();
			}
		}
	}
}

function showFastMenu() 		
{ 
	var d = rheaGetElemByID("btnBO_milkerCleaning");
	
	if (isMilkerAlive)
		rheaSetDisplayMode (d, "table");
	else
		rheaHideElem (d);
		
	setupQuickMenu();

	rheaShowElem (rheaGetElemByID("divFastMenu")); 
}
function hideFastMenu()			{ rheaHideElem (rheaGetElemByID("divFastMenu")); }
function onBtnCleaning()		
{ 
	resetTimerGotoPageStandby();
	pinCodePanel.show (
		function callbackOK()		{ console.log("rinsing"); rhea.requestGPUCleaning(160); hideFastMenu(); }
		,function callbackKO()		{ hideFastMenu(); }
	);
}

function onBtnMilkerCleaning()
{
	resetTimerGotoPageStandby();
	pinCodePanel.show (
		function callbackOK() {
			console.log("milker cleaning");
			rhea.ajax ("getMilkerType", "").then( function(result)
			{
				var data = JSON.parse(result);
				switch (parseInt(data.mType))
				{
					default: //venturi:
						rhea.requestGPUCleaning(32);
						hideFastMenu();
						break;
						
					case 2: //indux
						rhea.requestGPUCleaning(32);
						rhea.gotoSpecialURL("gotoMilkerCleaning.html");
						break;
				}
			})
			.catch( function(result)
			{
				rhea.requestGPUCleaning(32);
			});		
		}

		,function callbackKO()		{ hideFastMenu(); }
	);	
}

function onBtnDataAudit()
{
	resetTimerGotoPageStandby();
	pinCodePanel.show (
		function callbackOK() 	{ rhea.gotoSpecialURL("gotoPartialDataAudit.html"); }
		,function callbackKO()	{ hideFastMenu(); }
	);	
}

function onBtnFileInfo()
{
	var cpu = rheaGetElemByID("FileInfo_CpuFilename");
	var cpuModel = rheaGetElemByID("FileInfo_CpuModel");
	var gui = rheaGetElemByID("FileInfo_GuiFilename");
	var gpuVer = rheaGetElemByID("FileInfo_GpuVersion");
	var da3 = rheaGetElemByID("FileInfo_Da3Filename");

	resetTimerGotoPageStandby();

	hideFastMenu();
	rheaShowElem(rheaGetElemByID("FileInfo_div"));

	rhea.ajax ("getLastInstalledCPUFilename", "").then( function(result)
	{
		rheaSetElemHTML(cpu, result);
	});

	rhea.ajax ("getLastInstalledGUIFilename", "").then( function(result)
	{
		rheaSetElemHTML(gui, result);
	});

	rhea.ajax ("getDA3info", "").then( function(result)
	{
		var resJson = JSON.parse(result);
		rheaSetElemHTML(da3, resJson.filename + "<br><i>last time updated: " + resJson.lastUpdate + "</i>"); 
	});
	
	rhea.ajax("getGPUVer", "").then( function(result)
	{
		rheaSetElemHTML(gpuVer, result);
	});
	
	rhea.ajax("getCPUStrModelAndVer", "").then( function(result)
	{
		rheaSetElemHTML(cpuModel, result);
	});
}

function onFileInfoClose()
{
	resetTimerGotoPageStandby();
	rheaHideElem(rheaGetElemByID("FileInfo_div"));
}

//--------------------------------------------------------
function divLangMenu_setup(currentLangISO)
{
	var html = "<ul class='langList'>";
	var eLang = allLang.split(",");
	for (var i=0; i<eLang.length; i++)
	{
		var iso = eLang[i];
		var text= allLangLocale[i];
		
		var cssClass = "btnSingleLang";
		if (iso == currentLangISO)
			cssClass += " selected";
		html += "<li><div id='divLangMenu_" +iso +"' class='" +cssClass +"' onclick='divLangMenu_select(\"" +iso +"\")'><img draggable='false' src='img/flags/" +iso +".png'><p>" +text +"</p></div></li>";
	}
	html += "</ul>";
	
	var d = rheaGetElemByID("divLangMenu_content");
	rheaSetElemHTML(d, html);
}
		
function divLangMenu_open()
{
	var d = rheaGetElemByID("divLangMenu");
	rheaShowElem(d);
}

function divLangMenu_close()
{
	var d = rheaGetElemByID("divLangMenu");
	rheaHideElem(d);
}

function divLangMenu_select(isoOfSelectedLang)
{
	var eLang = allLang.split(",");
	for (var i=0; i<eLang.length; i++)
	{
		var iso = eLang[i];
		var d = rheaGetElemByID("divLangMenu_" +iso);
		rheaRemoveClassToElem(d, "selected");
		if (iso == isoOfSelectedLang)
		{
			rheaAddClassToElem(d, "selected");
			setLanguage(iso);
		}
	}
	divLangMenu_close();
}

function gotoPagePreparingSel(bCanUseBtnStop)
{
	var url = "pageSelInProgress.html";
	url += "?iconMenu=" +selRunning_iconNum +"&selNum=" +selRunning_selThatWasStarted +"&btnStop=" +bCanUseBtnStop;
	window.location = url;
}

function beverageBookingAnimation() {
	var loader = document.querySelector("#progress-cursor");
	var intervalID = setInterval(function () {
		var left = loader.offsetLeft;
		var width = loader.offsetWidth;
		
		if (left !== 190 && width === 100) {
			loader.style.left = (left + 1) + 'px'
		} else {
			if (width > 1 && left !== 0) {
				loader.style.width = (width - 1) + 'px'
				loader.style.left = (left + 1) + 'px'
			} else {
				loader.style.left = "0px";
				loader.style.width = (width + 1) + 'px'
			}
		}
	}, 5);
}

function milkPopup_open() {
	var modalContent = rheaGetElemByID("rheaModalContent");
	rheaSetElemHTML(modalContent, getPopup(POPUP.MILK));
	
	// POP-UP TITLE
	if (typeof refillFreshMilkPopupTitle != 'undefined' && refillFreshMilkPopupTitle) {
		var d = rheaGetElemByID("modalTitle");
		rheaSetElemHTML(d, refillFreshMilkPopupTitle);
	}

	// POP-UP DESCRIPTION
	if (typeof refillFreshMilkPopupDesc != 'undefined' && refillFreshMilkPopupDesc) {
		var d = rheaGetElemByID("modalDescription");
		rheaSetElemHTML(d, refillFreshMilkPopupDesc);
	}

	// POP-UP CONFIRM
	if (typeof refillFreshMilkPopupConfirm != 'undefined' && refillFreshMilkPopupConfirm) {
		var d = rheaGetElemByID("btnMilkConfirmLabel");
		rheaSetElemHTML(d, refillFreshMilkPopupConfirm);
	}

	// POP-UP CANCEL
	if (typeof refillFreshMilkPopupCancel != 'undefined' && refillFreshMilkPopupCancel) {
		var d = rheaGetElemByID("btnMilkCancelLabel");
		rheaSetElemHTML(d, refillFreshMilkPopupCancel);
	}

	rheaShowElem(rheaGetElemByID("rheaModal"));
}

function errorCupPopup_open(type) {
	var modalContent = rheaGetElemByID("rheaModalContent");
	rheaSetElemHTML(modalContent, getPopup(POPUP.WENGLOR));
	
	if (type === 'down' && typeof needSmallCupDownMessage != 'undefined' && needSmallCupDownMessage) {
		var d = rheaGetElemByID("modalCupTitle");
		rheaSetElemHTML(d, needSmallCupDownMessage);
	}

	if (type === 'up' && typeof needSmallCupUpMessage != 'undefined' && needSmallCupUpMessage) {
		var d = rheaGetElemByID("modalCupTitle");
		rheaSetElemHTML(d, needSmallCupUpMessage);
	}

	if (type === 'downup' && typeof needSmallCupUpDownMessage != 'undefined' && needSmallCupUpDownMessage) {
		var d = rheaGetElemByID("modalCupTitle");
		rheaSetElemHTML(d, needSmallCupUpDownMessage);
	}

	if (type === 'big' && typeof needBigCupMessage != 'undefined' && needBigCupMessage) {
		var d = rheaGetElemByID("modalCupTitle");
		rheaSetElemHTML(d, needBigCupMessage);
	}

	if (type === 'any' && typeof needGenericCupMessage != 'undefined' && needGenericCupMessage) {
		var d = rheaGetElemByID("modalCupTitle");
		rheaSetElemHTML(d, needGenericCupMessage);
	}

	rheaShowElem(rheaGetElemByID("rheaModal"));
}

function milkPopup_confirm() {
	rhea.ajax("freshMilkRefilled", "")
		.then(function() {

		})
		.catch(function() {

		});

	milkPopup_cancel();
}

function milkPopup_cancel() {
	rheaHideElem(rheaGetElemByID("rheaModal"));
}

function cupConfirmPopup_cancel() {
	rheaHideElem(rheaGetElemByID("rheaModal"));
}

function showBtnAllInOne() {
	var btnsContainer = rheaGetElemByID("btnsContainer");
		btnsContainer.style.marginTop = '85px';

	var btnAllInOne = rheaGetElemByID("btnBO_AllInOne");
		btnAllInOne.style.display = 'table';

	var btnQuadratoGrosso = rheaGetElemByID("btnBO_hideFastMenu");
		btnQuadratoGrosso.style.top = '375px';	
}

function onBtnAllInOne()
{
	rhea.requestGPUCleaning(162);
	hideFastMenu();
}

</script>


</html>
